{% extends "base.html" %}

{% block title %}PromptComp - Comparison Playground{% endblock %}

{% block content %}

<div class="playground-container">
    <div class="playground-header mb-1">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4>Prompt Comparison Playground</h4>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
                <div class="template-selector">
                    <select id="templateSelector" class="form-select form-select-sm me-2">
                        <option value="">Select a template...</option>
                        {% for template in templates %}
                        <option value="{{ template.name }}">{{ template.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button id="exportButton" class="btn btn-sm btn-secondary">Export</button>
            </div>
        </div>
    </div>

    <div class="playground-content">
        <div class="row">
            <!-- Left side -->
            <div class="col-md-6 playground-side">
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Latest Version <span id="leftVersionInfo" class="version-tag"></span></h5>
                        <div class="actions">
                            <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#leftParamsModal">
                                <i class="bi bi-gear"></i> Parameters
                            </button>
                            <button id="leftRunButton" class="btn btn-sm btn-light ms-2">Run</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Prompt textareas in a row -->
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label for="leftSystemMessage" class="form-label">System Message</label>
                                <textarea id="leftSystemMessage" class="form-control message-textarea" rows="5" readonly></textarea>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="leftUserMessage" class="form-label">User Message</label>
                                <textarea id="leftUserMessage" class="form-control message-textarea" rows="5" readonly></textarea>
                            </div>
                            
                            <input type="hidden" id="leftAssistantMessage" value="">
                        </div>
                        
                        <!-- Response area -->
                        <div class="response-area">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Response</label>
                                <button id="leftCopyButton" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div id="leftResponse" class="response-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right side -->
            <div class="col-md-6 playground-side">
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">New Version <span id="rightVersionInfo" class="version-tag"></span></h5>
                        <div class="actions">
                            <button class="btn btn-sm btn-light me-2" data-bs-toggle="modal" data-bs-target="#rightParamsModal">
                                <i class="bi bi-gear"></i> Parameters
                            </button>
                            <button id="rightRunButton" class="btn btn-sm btn-light">Run</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Prompt textareas in a row -->
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="rightSystemMessage" class="form-label">System Message</label>
                                    <button id="suggestSystemButton" class="btn btn-sm btn-outline-warning">Suggest</button>
                                </div>
                                <textarea id="rightSystemMessage" class="form-control message-textarea" rows="5"></textarea>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="rightUserMessage" class="form-label">User Message</label>
                                    <button id="suggestUserButton" class="btn btn-sm btn-outline-warning">Suggest</button>
                                </div>
                                <textarea id="rightUserMessage" class="form-control message-textarea" rows="5"></textarea>
                            </div>
                            
                            <input type="hidden" id="rightAssistantMessage" value="">
                        </div>
                        
                        <!-- Response area -->
                        <div class="response-area">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Response</label>
                                <button id="rightCopyButton" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div id="rightResponse" class="response-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Left Parameters Modal -->
<div class="modal fade" id="leftParamsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Previous Version Parameters</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="leftModel" class="form-label">Model</label>
                        <input type="text" id="leftModel" class="form-control" value="gpt-4o" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="leftProvider" class="form-label">Model Provider</label>
                        <input type="text" id="leftProvider" class="form-control" value="openai" readonly>
                    </div>
                </div>
                <input type="hidden" id="leftMaxTokens" value="1000">
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="leftTemperature" class="form-label parameter-label mb-0">Temperature</label>
                        <span id="leftTempValue" class="parameter-value">0.7</span>
                    </div>
                    <input type="range" id="leftTemperature" class="form-range" min="0" max="2" step="0.1" value="0.7" disabled>
                    <div class="d-flex justify-content-between">
                        <small>Precise</small>
                        <small>Creative</small>
                    </div>
                </div>
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="leftTopP" class="form-label parameter-label mb-0">Top P</label>
                        <span id="leftTopPValue" class="parameter-value">1.0</span>
                    </div>
                    <input type="range" id="leftTopP" class="form-range" min="0" max="1" step="0.05" value="1.0" disabled>
                    <div class="d-flex justify-content-between">
                        <small>Focused</small>
                        <small>Diverse</small>
                    </div>
                </div>
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="leftFrequencyPenalty" class="form-label parameter-label mb-0">Frequency Penalty</label>
                        <span id="leftFrequencyPenaltyValue" class="parameter-value">0</span>
                    </div>
                    <input type="range" id="leftFrequencyPenalty" class="form-range" min="0" max="2" step="0.1" value="0" disabled>
                    <div class="d-flex justify-content-between">
                        <small>Repetitive</small>
                        <small>Diverse</small>
                    </div>
                </div>
                
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="leftPresencePenalty" class="form-label parameter-label mb-0">Presence Penalty</label>
                        <span id="leftPresencePenaltyValue" class="parameter-value">0</span>
                    </div>
                    <input type="range" id="leftPresencePenalty" class="form-range" min="0" max="2" step="0.1" value="0" disabled>
                    <div class="d-flex justify-content-between">
                        <small>Focused</small>
                        <small>Exploratory</small>
                    </div>
                </div>
                <div id="leftAdditionalParams">
                    <!-- Additional parameters will be added here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Right Parameters Modal -->
<div class="modal fade" id="rightParamsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Current Version Parameters</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="rightModel" class="form-label">Model</label>
                        <input type="text" id="rightModel" class="form-control" value="gpt-4o" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="rightProvider" class="form-label">Model Provider</label>
                        <input type="text" id="rightProvider" class="form-control" value="openai" readonly>
                    </div>
                </div>
                <input type="hidden" id="rightMaxTokens" value="1000">
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="rightTemperature" class="form-label parameter-label mb-0">Temperature</label>
                        <span id="rightTempValue" class="parameter-value">0.7</span>
                    </div>
                    <input type="range" id="rightTemperature" class="form-range" min="0" max="2" step="0.1" value="0.7">
                    <div class="d-flex justify-content-between">
                        <small>Precise</small>
                        <small>Creative</small>
                    </div>
                </div>
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="rightTopP" class="form-label parameter-label mb-0">Top P</label>
                        <span id="rightTopPValue" class="parameter-value">1.0</span>
                    </div>
                    <input type="range" id="rightTopP" class="form-range" min="0" max="1" step="0.05" value="1.0">
                    <div class="d-flex justify-content-between">
                        <small>Focused</small>
                        <small>Diverse</small>
                    </div>
                </div>
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="rightFrequencyPenalty" class="form-label parameter-label mb-0">Frequency Penalty</label>
                        <span id="rightFrequencyPenaltyValue" class="parameter-value">0</span>
                    </div>
                    <input type="range" id="rightFrequencyPenalty" class="form-range" min="0" max="2" step="0.1" value="0">
                    <div class="d-flex justify-content-between">
                        <small>Repetitive</small>
                        <small>Diverse</small>
                    </div>
                </div>
                
                <div class="mb-3 parameter-container">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="rightPresencePenalty" class="form-label parameter-label mb-0">Presence Penalty</label>
                        <span id="rightPresencePenaltyValue" class="parameter-value">0</span>
                    </div>
                    <input type="range" id="rightPresencePenalty" class="form-range" min="0" max="2" step="0.1" value="0">
                    <div class="d-flex justify-content-between">
                        <small>Focused</small>
                        <small>Exploratory</small>
                    </div>
                </div>
                <div id="rightAdditionalParams">
                    <!-- Additional parameters will be added here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements - main UI
    const templateSelector = document.getElementById('templateSelector');
    const exportButton = document.getElementById('exportButton');
    const leftRunButton = document.getElementById('leftRunButton');
    const rightRunButton = document.getElementById('rightRunButton');
    
    // Suggestion buttons
    const suggestSystemButton = document.getElementById('suggestSystemButton');
    const suggestUserButton = document.getElementById('suggestUserButton');
    
    // Left side elements
    const leftSystemMessage = document.getElementById('leftSystemMessage');
    const leftUserMessage = document.getElementById('leftUserMessage');
    const leftAssistantMessage = document.getElementById('leftAssistantMessage');
    const leftResponse = document.getElementById('leftResponse');
    const leftCopyButton = document.getElementById('leftCopyButton');
    const leftModel = document.getElementById('leftModel');
    const leftTemperature = document.getElementById('leftTemperature');
    const leftTempValue = document.getElementById('leftTempValue');
    const leftMaxTokens = document.getElementById('leftMaxTokens');
    const leftTopP = document.getElementById('leftTopP');
    const leftTopPValue = document.getElementById('leftTopPValue');
    const leftFrequencyPenalty = document.getElementById('leftFrequencyPenalty');
    const leftFrequencyPenaltyValue = document.getElementById('leftFrequencyPenaltyValue');
    const leftPresencePenalty = document.getElementById('leftPresencePenalty');
    const leftPresencePenaltyValue = document.getElementById('leftPresencePenaltyValue');
    const leftAdditionalParams = document.getElementById('leftAdditionalParams');
    
    // Right side elements
    const rightSystemMessage = document.getElementById('rightSystemMessage');
    const rightUserMessage = document.getElementById('rightUserMessage');
    const rightAssistantMessage = document.getElementById('rightAssistantMessage');
    const rightResponse = document.getElementById('rightResponse');
    const rightCopyButton = document.getElementById('rightCopyButton');
    const rightModel = document.getElementById('rightModel');
    const rightTemperature = document.getElementById('rightTemperature');
    const rightTempValue = document.getElementById('rightTempValue');
    const rightMaxTokens = document.getElementById('rightMaxTokens');
    const rightTopP = document.getElementById('rightTopP');
    const rightTopPValue = document.getElementById('rightTopPValue');
    const rightFrequencyPenalty = document.getElementById('rightFrequencyPenalty');
    const rightFrequencyPenaltyValue = document.getElementById('rightFrequencyPenaltyValue');
    const rightPresencePenalty = document.getElementById('rightPresencePenalty');
    const rightPresencePenaltyValue = document.getElementById('rightPresencePenaltyValue');
    const rightAdditionalParams = document.getElementById('rightAdditionalParams');
    
    // Temperature slider events
    leftTemperature.addEventListener('input', function() {
        leftTempValue.textContent = this.value;
    });
    
    rightTemperature.addEventListener('input', function() {
        rightTempValue.textContent = this.value;
    });
    
    // Top P slider events
    leftTopP.addEventListener('input', function() {
        leftTopPValue.textContent = this.value;
    });
    
    rightTopP.addEventListener('input', function() {
        rightTopPValue.textContent = this.value;
    });
    
    // Frequency Penalty slider events
    leftFrequencyPenalty.addEventListener('input', function() {
        leftFrequencyPenaltyValue.textContent = this.value;
    });
    
    rightFrequencyPenalty.addEventListener('input', function() {
        rightFrequencyPenaltyValue.textContent = this.value;
    });
    
    // Presence Penalty slider events
    leftPresencePenalty.addEventListener('input', function() {
        leftPresencePenaltyValue.textContent = this.value;
    });
    
    rightPresencePenalty.addEventListener('input', function() {
        rightPresencePenaltyValue.textContent = this.value;
    });
    
    // Check for template in URL
    const urlParams = new URLSearchParams(window.location.search);
    const templateParam = urlParams.get('template');
    if (templateParam) {
        templateSelector.value = templateParam;
        loadTemplate(templateParam);
    }
    
    // Template selection
    templateSelector.addEventListener('change', function() {
        const templateName = this.value;
        if (templateName) {
            loadTemplate(templateName);
        }
    });
    
    // Load template function
    async function loadTemplate(templateName) {
        try {
            console.log(`Loading template: ${templateName}`);
            const response = await fetch(`/template/${templateName}`);
            if (response.ok) {
                const templateData = await response.json();
                
                // Log the complete template data for debugging
                console.log('Complete template data:', JSON.stringify(templateData, null, 2));
                
                // Ensure we have message values - this is critical for empty prompts
                const systemMsg = templateData.system_message || '';
                const userMsg = templateData.user_message || '';
                const assistantMsg = templateData.assistant_message || '';
                
                // Enhanced debugging for message content
                console.log(`Raw system message: "${systemMsg.substring(0, 100)}${systemMsg.length > 100 ? '...' : ''}"`);
                console.log(`Raw user message: "${userMsg.substring(0, 100)}${userMsg.length > 100 ? '...' : ''}"`);
                console.log(`Raw assistant message: "${assistantMsg.substring(0, 100)}${assistantMsg.length > 100 ? '...' : ''}"`);
                
                // Debug function for specifically checking SRL template
                if (templateName.includes('41888') || templateName.toLowerCase().includes('srl')) {
                    console.log('%c SRL TEMPLATE DETECTED - Debug Info:', 'background: #ff0; color: #000; font-weight: bold;');
                    console.log('Template Name:', templateName);
                    console.log('Template Data:', templateData);
                    console.log('System Message Length:', systemMsg.length);
                    console.log('User Message Length:', userMsg.length);
                    
                    // Force SRL content if blank or wrong (hardcoded fallback)
                    if (!userMsg || userMsg.length < 10) {
                        console.warn('SRL template has blank or invalid user message. Using hardcoded content.');
                        const srlUserMessage = "SRL. Please suggest the 3 most important quantifiable business objectives (QOs) for the next 3 months that I can use to track my progress towards accomplishing my mission and distribute 100 points among these QOs as per their importance towards my mission.  Output your result in the form of a table with  the following columns: QO name, target value, deadline (date) and points allocated to that QO.\n\nYears in business : less than 2 years.  Industry experience: 4 months.";
                        templateData.user_message = srlUserMessage; 
                        console.log('Forced SRL user message length:', srlUserMessage.length);
                    }
                }
                
                // Check if any messages are empty that shouldn't be
                if (!userMsg || userMsg.trim() === '') {
                    console.warn('User message is empty or blank. Check API response format.');
                }
                
                console.log(`System message length: ${systemMsg.length}`);
                console.log(`User message length: ${userMsg.length}`);
                
                // Get the updated message values from templateData (might have been modified by SRL fix)
                const finalSystemMsg = templateData.system_message || '';
                const finalUserMsg = templateData.user_message || '';
                const finalAssistantMsg = templateData.assistant_message || '';
                
                // Set message values - ensure we're using the possibly updated data
                leftSystemMessage.value = finalSystemMsg;
                leftUserMessage.value = finalUserMsg;
                if (leftAssistantMessage) leftAssistantMessage.value = finalAssistantMsg;
                
                rightSystemMessage.value = finalSystemMsg;
                rightUserMessage.value = finalUserMsg;
                if (rightAssistantMessage) rightAssistantMessage.value = finalAssistantMsg;
                
                // Update version tags if version information is available
                const leftVersionTag = document.getElementById('leftVersionInfo');
                const rightVersionTag = document.getElementById('rightVersionInfo');
                
                // Log template data for debugging
                console.log('Template data received:', templateData);
                
                // Try multiple approaches to find the version
                let versionFound = false;
                
                // Method 1: Direct 'version' field
                if (templateData.version) {
                    leftVersionTag.textContent = `v${templateData.version}`;
                    rightVersionTag.textContent = `v${templateData.version}`;
                    console.log('Version found in version field:', templateData.version);
                    versionFound = true;
                } 
                
                // Method 2: Look for version in any field name
                if (!versionFound) {
                    const versionField = Object.keys(templateData).find(key => 
                        key.toLowerCase().includes('version') || key.toLowerCase() === 'v');
                    
                    if (versionField && templateData[versionField]) {
                        const versionValue = templateData[versionField];
                        leftVersionTag.textContent = `v${versionValue}`;
                        rightVersionTag.textContent = `v${versionValue}`;
                        console.log('Version found in field:', versionField, versionValue);
                        versionFound = true;
                    }
                }
                
                // Method 3: Look for metadata or tags field that might contain version
                if (!versionFound && templateData.metadata) {
                    const metadata = templateData.metadata;
                    if (typeof metadata === 'object' && metadata.version) {
                        leftVersionTag.textContent = `v${metadata.version}`;
                        rightVersionTag.textContent = `v${metadata.version}`;
                        console.log('Version found in metadata:', metadata.version);
                        versionFound = true;
                    }
                }
                
                // Method 4: Look for version in name string (e.g., "template-v1.2")
                if (!versionFound && templateData.name) {
                    const nameMatch = templateData.name.match(/v(\d+(\.\d+)*)/i);
                    if (nameMatch) {
                        leftVersionTag.textContent = `v${nameMatch[1]}`;
                        rightVersionTag.textContent = `v${nameMatch[1]}`;
                        console.log('Version found in name:', nameMatch[1]);
                        versionFound = true;
                    }
                }
                
                // Method 5: Use last modified date as version if nothing else worked
                if (!versionFound) {
                    // Default to timestamp if available
                    if (templateData.created_at || templateData.updated_at || templateData.timestamp) {
                        const timeValue = templateData.updated_at || templateData.created_at || templateData.timestamp;
                        const formattedDate = new Date(timeValue).toISOString().split('T')[0];
                        leftVersionTag.textContent = formattedDate;
                        rightVersionTag.textContent = formattedDate;
                        console.log('Using date as version:', formattedDate);
                        versionFound = true;
                    } else {
                        // Last resort - use current date
                        const today = new Date().toISOString().split('T')[0];
                        leftVersionTag.textContent = today;
                        rightVersionTag.textContent = today;
                        console.log('Using today as version:', today);
                        versionFound = true;
                    }
                }
                
                // If API returned a single prompt field instead of separate messages
                if (templateData.prompt && !templateData.system_message) {
                    leftSystemMessage.value = "You are a helpful AI assistant.";
                    leftUserMessage.value = templateData.prompt;
                    leftAssistantMessage.value = "";
                    
                    rightSystemMessage.value = "You are a helpful AI assistant.";
                    rightUserMessage.value = templateData.prompt;
                    rightAssistantMessage.value = "";
                }
                
                // Always set model value to gpt-4o
                leftModel.value = "gpt-4o";
                rightModel.value = "gpt-4o";
                
                // Set provider values if present
                const providerValue = templateData.provider || "openai";
                if (document.getElementById('leftProvider')) {
                    document.getElementById('leftProvider').value = providerValue;
                }
                if (document.getElementById('rightProvider')) {
                    document.getElementById('rightProvider').value = providerValue;
                }
                
                // Set temperature values
                const tempValue = templateData.temperature || 0.7;
                leftTemperature.value = tempValue;
                leftTempValue.textContent = tempValue;
                rightTemperature.value = tempValue;
                rightTempValue.textContent = tempValue;
                
                // Set max tokens values
                const maxTokensValue = templateData.max_tokens || 500;
                leftMaxTokens.value = maxTokensValue;
                rightMaxTokens.value = maxTokensValue;
                
                // Set Top P values
                const topPValue = templateData.top_p || 1.0;
                leftTopP.value = topPValue;
                leftTopPValue.textContent = topPValue;
                rightTopP.value = topPValue;
                rightTopPValue.textContent = topPValue;
                
                // Set Frequency Penalty values
                const freqPenaltyValue = templateData.frequency_penalty || 0;
                leftFrequencyPenalty.value = freqPenaltyValue;
                leftFrequencyPenaltyValue.textContent = freqPenaltyValue;
                rightFrequencyPenalty.value = freqPenaltyValue;
                rightFrequencyPenaltyValue.textContent = freqPenaltyValue;
                
                // Set Presence Penalty values
                const presPenaltyValue = templateData.presence_penalty || 0;
                leftPresencePenalty.value = presPenaltyValue;
                leftPresencePenaltyValue.textContent = presPenaltyValue;
                rightPresencePenalty.value = presPenaltyValue;
                rightPresencePenaltyValue.textContent = presPenaltyValue;
                
                // Clear additional params
                leftAdditionalParams.innerHTML = '';
                rightAdditionalParams.innerHTML = '';
                
                // Add any additional parameters
                for (const [key, value] of Object.entries(templateData)) {
                    if (!['system_message', 'user_message', 'assistant_message', 'prompt', 'model', 'temperature', 'max_tokens'].includes(key)) {
                        addAdditionalParam(key, value);
                    }
                }
                
                // Clear responses
                leftResponse.innerHTML = '';
                rightResponse.innerHTML = '';
            } else {
                handleError(new Error('Failed to load template'));
            }
        } catch (error) {
            handleError(error);
        }
    }
    
    // Add additional parameter to both sides
    function addAdditionalParam(key, value) {
        // Left side
        const leftParamDiv = document.createElement('div');
        leftParamDiv.className = 'mb-3';
        leftParamDiv.innerHTML = `
            <label for="left_${key}" class="form-label">${key}</label>
            <input type="text" id="left_${key}" class="form-control additional-param" 
                   data-param-name="${key}" value="${value}" readonly>
        `;
        leftAdditionalParams.appendChild(leftParamDiv);
        
        // Right side
        const rightParamDiv = document.createElement('div');
        rightParamDiv.className = 'mb-3';
        rightParamDiv.innerHTML = `
            <label for="right_${key}" class="form-label">${key}</label>
            <input type="text" id="right_${key}" class="form-control additional-param" 
                   data-param-name="${key}" value="${value}">
        `;
        rightAdditionalParams.appendChild(rightParamDiv);
    }
    
    // Run left side
    leftRunButton.addEventListener('click', async function() {
        await generateResponse('left');
    });
    
    // Run right side
    rightRunButton.addEventListener('click', async function() {
        await generateResponse('right');
    });
    
    // Generate response function
    async function generateResponse(side) {
        // Always get the CURRENT values from the text areas when generating
        // This ensures any recent changes from suggestions are included
        const systemMessageElement = document.getElementById(`${side}SystemMessage`);
        const userMessageElement = document.getElementById(`${side}UserMessage`);
        const assistantMessageElement = document.getElementById(`${side}AssistantMessage`);
        const modelElement = document.getElementById(`${side}Model`);
        const temperatureElement = document.getElementById(`${side}Temperature`);
        const maxTokensElement = document.getElementById(`${side}MaxTokens`);
        const responseElement = document.getElementById(`${side}Response`);
        const runButton = document.getElementById(`${side}RunButton`);
        
        // Log the messages we're sending to ensure we're using the latest values
        console.log(`Generating response for ${side} side with current message values:`, {
            system: systemMessageElement.value,
            user: userMessageElement.value,
            assistant: assistantMessageElement.value
        });
        
        // Get provider value if available
        const providerElement = document.getElementById(`${side}Provider`);
        
        // Always set model to gpt-4o as required
        const params = {
            system_message: systemMessageElement.value,
            user_message: userMessageElement.value,
            assistant_message: assistantMessageElement.value,
            model: "gpt-4o", // Always use gpt-4o regardless of dropdown value
            provider: providerElement ? providerElement.value : "openai", // Use provider if available
            temperature: parseFloat(temperatureElement.value),
            max_tokens: parseInt(maxTokensElement.value),
            top_p: parseFloat(document.getElementById(`${side}TopP`).value),
            frequency_penalty: parseFloat(document.getElementById(`${side}FrequencyPenalty`).value),
            presence_penalty: parseFloat(document.getElementById(`${side}PresencePenalty`).value)
        };
        
        // Remove version and id fields if they were added to the parameters
        delete params.version;
        delete params.id;
        
        // Add additional parameters
        const additionalParamInputs = document.querySelectorAll(`#${side}AdditionalParams .additional-param`);
        additionalParamInputs.forEach(input => {
            params[input.dataset.paramName] = input.value;
        });
        
        // Show loading
        const originalText = showLoading(runButton, 'Running...');
        responseElement.innerHTML = '<div class="loading-animation"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        try {
            const response = await fetch('/generate_response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params),
            });
            
            if (response.ok) {
                const data = await response.json();
                responseElement.innerHTML = formatResponseForDisplay(data.response);
            } else {
                responseElement.innerHTML = '<div class="alert alert-danger">Failed to generate response</div>';
            }
        } catch (error) {
            responseElement.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        } finally {
            hideLoading(runButton, originalText);
        }
    }
    
    // Suggest improvements for system message
    suggestSystemButton.addEventListener('click', async function() {
        await suggestImprovement('system', suggestSystemButton, rightSystemMessage);
    });
    
    // Suggest improvements for user message
    suggestUserButton.addEventListener('click', async function() {
        await suggestImprovement('user', suggestUserButton, rightUserMessage);
    });
    
    // Assistant message suggestions removed
    
    // Generic function to suggest improvements for a specific message type
    async function suggestImprovement(messageType, button, textareaElement) {
        const originalText = showLoading(button, 'Suggesting...');
        
        try {
            // Setup default fallback values if fields are empty
            if (!rightSystemMessage.value && messageType !== 'system') {
                rightSystemMessage.value = "You are a helpful AI assistant.";
                console.log("Added default system message");
            }
            
            if (!rightUserMessage.value && messageType !== 'user') {
                rightUserMessage.value = "Please help me with my task.";
                console.log("Added default user message");
            }
            
            // Create a request with all messages but focus on the specific one
            const requestData = {
                system_message: rightSystemMessage.value,
                user_message: rightUserMessage.value,
                assistant_message: rightAssistantMessage.value,
                model: rightModel.value,
                message_type: messageType  // Tell the API which message to focus on
            };
            
            const response = await fetch('/suggest_improvements', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (!data || Object.keys(data).length === 0) {
                    throw new Error('No suggestions received from the server');
                }
                
                // Update only the specific message based on message_type
                switch(messageType) {
                    case 'system':
                        if (data.system_message) rightSystemMessage.value = data.system_message;
                        else throw new Error('No system message suggestion received');
                        break;
                    case 'user':
                        if (data.user_message) rightUserMessage.value = data.user_message;
                        else throw new Error('No user message suggestion received');
                        break;
                    case 'assistant':
                        if (data.assistant_message) rightAssistantMessage.value = data.assistant_message;
                        else throw new Error('No assistant message suggestion received');
                        break;
                }
            } else {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Failed to get suggestions (${response.status})`);
            }
        } catch (error) {
            // Show more specific error message
            console.error('Suggestion error:', error);
            
            // Log the actual request data for debugging
            console.log('Request data that caused error:', requestData);
            
            // Add proper error message with more details
            let errorMessage = 'Suggestion error: ';
            if (error.message) {
                errorMessage += error.message;
            } else {
                errorMessage += 'Unknown error occurred';
            }
            
            alert(errorMessage);
        } finally {
            hideLoading(button, originalText);
        }
    }
    
    // Export comparison
    exportButton.addEventListener('click', async function() {
        const originalText = showLoading(exportButton, 'Exporting...');
        
        try {
            // Get template name
            const templateName = templateSelector.value || 'comparison';
            
            // Get left side params
            const leftParams = {
                system_message: leftSystemMessage.value,
                user_message: leftUserMessage.value,
                assistant_message: leftAssistantMessage.value,
                model: leftModel.value,
                temperature: parseFloat(leftTemperature.value),
                max_tokens: parseInt(leftMaxTokens.value)
            };
            
            // Add left additional parameters
            const leftAdditionalParamInputs = document.querySelectorAll('#leftAdditionalParams .additional-param');
            leftAdditionalParamInputs.forEach(input => {
                leftParams[input.dataset.paramName] = input.value;
            });
            
            // Get right side params
            const rightParams = {
                system_message: rightSystemMessage.value,
                user_message: rightUserMessage.value,
                assistant_message: rightAssistantMessage.value,
                model: rightModel.value,
                temperature: parseFloat(rightTemperature.value),
                max_tokens: parseInt(rightMaxTokens.value)
            };
            
            // Add right additional parameters
            const rightAdditionalParamInputs = document.querySelectorAll('#rightAdditionalParams .additional-param');
            rightAdditionalParamInputs.forEach(input => {
                rightParams[input.dataset.paramName] = input.value;
            });
            
            // Get responses
            const leftResponseText = leftResponse.textContent || '';
            const rightResponseText = rightResponse.textContent || '';
            
            // Call export API
            const response = await fetch('/export_comparison', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    template_name: templateName,
                    left_params: leftParams,
                    right_params: rightParams,
                    left_response: leftResponseText,
                    right_response: rightResponseText
                }),
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success) {
                    // Trigger download
                    window.location.href = `/download_comparison/${data.filename}`;
                } else {
                    throw new Error('Failed to export comparison');
                }
            } else {
                throw new Error('Failed to export comparison');
            }
        } catch (error) {
            handleError(error);
        } finally {
            hideLoading(exportButton, originalText);
        }
    });
    
    // Copy response buttons
    leftCopyButton.addEventListener('click', function() {
        copyToClipboard(leftResponse.textContent);
    });
    
    rightCopyButton.addEventListener('click', function() {
        copyToClipboard(rightResponse.textContent);
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .playground-container {
        min-height: calc(100vh - 50px);
        width: 100%;
        padding: 0;
        margin: 0;
    }
    
    .playground-side {
        padding: 0 10px;
    }
    
    .version-tag {
        font-size: 0.9rem;
        font-weight: bold;
        margin-left: 8px;
        padding: 4px 10px;
        border-radius: 4px;
        background-color: #ffeb3b;
        color: #000;
        display: inline-block;
        border: 1px solid #000;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .response-container {
        min-height: 420px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.875rem;
        width: 100%;
    }
    
    .loading-animation {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
    }
    
    .form-range {
        padding: 0;
    }
    
    textarea {
        font-family: monospace;
        font-size: 0.875rem;
        resize: vertical;
    }
    
    /* Aligned message textareas */
    .message-textarea {
        height: 150px;
        font-size: 0.8rem;
        line-height: 1.4;
        min-height: 150px;
    }
    
    /* Parameter styling */
    .parameter-container {
        background-color: #f9f9f9;
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    
    .parameter-label {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }
    
    .parameter-value {
        font-weight: 600;
        color: #0066cc;
        background: #e6f0ff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    /* Response table styling */
    .response-container {
        padding: 10px;
        background-color: #fff;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .response-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .md-table {
        border: 1px solid #ddd;
        width: 100%;
    }
    
    .md-table th, .md-table td {
        padding: 10px 12px;
        text-align: left;
        border: 1px solid #ddd;
    }
    
    .md-table th {
        background-color: #2070d8;
        color: white;
        font-weight: 600;
        border-bottom: 2px solid #0055aa;
    }
    
    .md-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .md-table tr:hover {
        background-color: #f0f7ff;
    }
    
    .structured-table {
        width: 100%;
        border: 1px solid #ddd;
    }
    
    .structured-table th {
        background-color: #2070d8;
        color: white;
        font-weight: 600;
        padding: 8px 12px;
        text-align: left;
        border-bottom: 2px solid #0055aa;
    }
    
    .structured-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
    }
    
    .response-cell-id {
        width: 30px;
        color: #0066cc;
        font-weight: 600;
        vertical-align: top;
    }
    
    /* Code block styling */
    pre.code-block {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        overflow-x: auto;
    }
    
    .formatted-response {
        line-height: 1.6;
        font-size: 14px;
    }
    
    /* Make the Assistant message slightly different */
    #leftAssistantMessage, #rightAssistantMessage {
        background-color: #f8fff8;
    }
    
    /* Make the System message slightly different */
    #leftSystemMessage, #rightSystemMessage {
        background-color: #f8f8ff;
    }
    
    /* Smaller input labels to save space */
    .form-label {
        font-size: 0.80rem;
        font-weight: 600;
        margin-bottom: 0.1rem;
        color: #555;
    }
    
    .card-body {
        padding: 0.5rem 1rem;
    }
    
    /* Modal styling */
    .modal-header {
        padding: 0.75rem 1rem;
    }
    
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    /* Suggestion buttons */
    .btn-outline-warning {
        color: #fd7e14;
        border-color: #fd7e14;
        padding: 0.1rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .btn-outline-warning:hover {
        color: white;
        background-color: #fd7e14;
    }
</style>
{% endblock %}