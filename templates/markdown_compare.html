{% extends "base.html" %}

{% block title %}ChatGPT versus JiJa{% endblock %}

{% block content %}

<div class="playground-container">
    <div class="playground-header mb-1">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4>ChatGPT versus JiJa</h4>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
                <button id="exportButton" class="btn btn-sm btn-secondary">Export</button>
            </div>
        </div>
    </div>

    <div class="playground-content">
        <div class="row">
            <!-- Left side -->
            <div class="col-md-6 playground-side">
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">JiJa AI</h5>
                        <div class="actions">
                            <button id="runJijaGptButton" class="btn btn-sm btn-light">Run</button>
                            <input type="file" id="leftFileInput" class="d-none" accept=".md">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <textarea id="leftMarkdownInput" class="form-control small-textarea" rows="4" placeholder="Enter your question for JiJa AI..."></textarea>
                        </div>
                        <div id="leftContent" class="markdown-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right side -->
            <div class="col-md-6 playground-side">
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">JiJa</h5>
                        <div class="actions">
                            <button id="rightUploadButton" class="btn btn-sm btn-light">Upload CSV</button>
                            <input type="file" id="rightFileInput" class="d-none" accept=".csv">
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="rightContent" class="markdown-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const runJijaGptButton = document.getElementById('runJijaGptButton');
    const rightUploadButton = document.getElementById('rightUploadButton');
    const leftFileInput = document.getElementById('leftFileInput');
    const rightFileInput = document.getElementById('rightFileInput');
    const leftMarkdownInput = document.getElementById('leftMarkdownInput');
    const leftContent = document.getElementById('leftContent');
    const rightContent = document.getElementById('rightContent');
    const exportButton = document.getElementById('exportButton');
    
    // Store markdown content
    let leftMarkdown = '';
    let rightMarkdown = '';
    
    rightUploadButton.addEventListener('click', function() {
        rightFileInput.click();
    });
    
    // Auto-render when typing (with debounce)
    let debounceTimeout;
    leftMarkdownInput.addEventListener('input', function() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(function() {
            leftMarkdown = leftMarkdownInput.value;
            renderMarkdown(leftContent, leftMarkdown);
        }, 500); // Wait 500ms after typing stops
    });
    
    // Add JiJa Comp GPT button handler
    runJijaGptButton.addEventListener('click', async function() {
        const prompt = leftMarkdownInput.value.trim();
        if (!prompt) {
            alert('Please enter a question for JiJa AI');
            return;
        }
        
        // Show loading state
        const originalButtonText = runJijaGptButton.textContent;
        runJijaGptButton.textContent = 'Running...';
        runJijaGptButton.disabled = true;
        leftContent.innerHTML = '<div class="loading-animation"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Processing your question...</p></div>';
        
        try {
            const response = await fetch('/call_jija_comp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: prompt,
                    temperature: 0.7,
                    max_tokens: 1500
                }),
            });
            
            if (response.ok) {
                const data = await response.json();
                leftMarkdown = data.response;
                renderMarkdown(leftContent, leftMarkdown);
            } else {
                const errorData = await response.json();
                leftContent.innerHTML = `<div class="alert alert-danger">Error: ${errorData.error || 'Could not process your question'}</div>`;
            }
        } catch (error) {
            leftContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        } finally {
            runJijaGptButton.textContent = originalButtonText;
            runJijaGptButton.disabled = false;
        }
    });
    
    // No need for left file input handler since we're using the GPT directly
    
    rightFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileContent = e.target.result;
                
                // Check if it's a CSV file
                if (file.name.toLowerCase().endsWith('.csv')) {
                    // Parse CSV and extract "Value" column
                    const parsedData = parseCSV(fileContent);
                    const formattedContent = formatCSVValues(parsedData);
                    rightMarkdown = formattedContent;
                } else {
                    // Regular markdown file
                    rightMarkdown = fileContent;
                }
                
                renderMarkdown(rightContent, rightMarkdown);
            };
            reader.readAsText(file);
        }
    });
    
    // Parse CSV content
    function parseCSV(csvContent) {
        const lines = csvContent.split('\n');
        
        // Check if CSV has enough rows
        if (lines.length < 3) {
            alert('Error: CSV file does not have enough rows. Need at least 3 rows.');
            return [];
        }
        
        // Handle quoted fields with commas inside them
        const getFields = function(line) {
            const fields = [];
            let insideQuotes = false;
            let currentField = '';
            
            for (let j = 0; j < line.length; j++) {
                const char = line[j];
                
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    fields.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            
            // Add the last field
            fields.push(currentField.trim());
            return fields;
        };
        
        const result = [];
        
        try {
            // Get row 2 (index 1), column B (index 1)
            const row2 = lines[1];
            const row2Fields = getFields(row2);
            if (row2Fields.length >= 2) {
                let cell_B2 = row2Fields[1]; // Second column (B)
                // Remove surrounding quotes if present
                if (cell_B2.startsWith('"') && cell_B2.endsWith('"')) {
                    cell_B2 = cell_B2.substring(1, cell_B2.length - 1);
                }
                result.push(cell_B2);
            }
            
            // Get row 3 (index 2), column C (index 2)
            const row3 = lines[2];
            const row3Fields = getFields(row3);
            if (row3Fields.length >= 3) {
                let cell_C3 = row3Fields[2]; // Third column (C)
                // Remove surrounding quotes if present
                if (cell_C3.startsWith('"') && cell_C3.endsWith('"')) {
                    cell_C3 = cell_C3.substring(1, cell_C3.length - 1);
                }
                result.push(cell_C3);
            }
            
            if (result.length === 0) {
                alert('Error: Could not extract required cells from CSV');
            }
            
            return result;
        } catch (error) {
            console.error('Error parsing CSV:', error);
            alert('Error parsing CSV file: ' + error.message);
            return [];
        }
    }
    
    // Format the CSV values as a nicely formatted response
    function formatCSVValues(values) {
        if (values.length === 0) return '*No data found in the CSV file*';
        
        let formattedContent = '# JiJa Response\n\n';
        
        // Display cell B2 (first element in values)
        if (values.length >= 1) {
            formattedContent += `## Question\n\n${values[0]}\n\n`;
        }
        
        // Display cell C3 (second element in values)
        if (values.length >= 2) {
            formattedContent += `## Answer\n\n${values[1]}\n\n`;
        }
        
        return formattedContent;
    }
    
    // Render markdown
    function renderMarkdown(container, markdown) {
        container.innerHTML = marked.parse(markdown);
    }
    
    // Export comparison
    exportButton.addEventListener('click', async function() {
        // Ensure we have the latest content from textarea
        if (leftMarkdownInput.value) {
            leftMarkdown = leftMarkdownInput.value;
        }
        
        if (!leftMarkdown && !rightMarkdown) {
            alert('Please add content to at least one side before exporting');
            return;
        }
        
        try {
            const response = await fetch('/export_markdown_comparison', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    left_content: leftMarkdown,
                    right_content: rightMarkdown
                }),
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success) {
                    // Trigger download
                    window.location.href = `/download_comparison/${data.filename}`;
                } else {
                    throw new Error('Failed to export comparison');
                }
            } else {
                throw new Error('Failed to export comparison');
            }
        } catch (error) {
            alert(`Error exporting comparison: ${error.message}`);
        }
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .playground-container {
        min-height: calc(100vh - 50px);
        width: 100%;
        padding: 0;
        margin: 0;
    }
    
    .playground-side {
        padding: 0 10px;
    }
    
    .markdown-container {
        min-height: 400px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 10px;
        border-radius: 4px;
        background-color: white;
        border: 1px solid #ddd;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 16px;
        line-height: 1.6;
    }
    
    .small-textarea {
        font-family: monospace;
        font-size: 13px;
        resize: vertical;
        border-color: #ccc;
        min-height: 70px;
        max-height: 200px;
        padding: 8px;
    }
    
    .small-textarea:focus {
        border-color: #4299e1;
        box-shadow: 0 0 0 1px #4299e1;
    }
    
    .markdown-container h1, 
    .markdown-container h2, 
    .markdown-container h3 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .markdown-container h3 {
        color: #2070d8;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.3rem;
    }
    
    /* Table styles for markdown rendering */
    .markdown-container table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .markdown-container th,
    .markdown-container td {
        border: 1px solid #e2e8f0;
        padding: 12px 15px;
        text-align: left;
    }
    
    .markdown-container tr:nth-child(even) {
        background-color: #f8fafc;
    }
    
    .markdown-container tr:hover {
        background-color: #f1f5f9;
    }
    
    .markdown-container th {
        padding-top: 14px;
        padding-bottom: 14px;
        text-align: left;
        background-color: #2563eb;
        color: white;
        font-weight: 600;
        position: relative;
    }
    
    .markdown-container th:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: rgba(255,255,255,0.3);
    }
    
    .loading-animation {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #4a5568;
    }
    
    .loading-animation p {
        margin-top: 16px;
        font-size: 14px;
    }
</style>
{% endblock %}